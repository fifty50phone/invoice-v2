<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fifty Fifty POS v2</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => navigator.serviceWorker.register('service-worker.js'));
    }
  </script>

  <style>
    /* 72mm thermal printing */
    @media print {
      body { width: 72mm; margin: 0; font-size: 12px; }
      .no-print { display: none !important; }
    }
    /* Desktop layout help */
    .panel { min-height: 520px; }
    .table th, .table td { padding: 4px 6px; }
  </style>
</head>
<body class="bg-gray-100 text-gray-900 min-h-screen flex flex-col">

  <!-- Header -->
  <header class="no-print bg-purple-900 text-white text-center py-3 shadow">
    <img src="logo.png" alt="Logo" class="w-20 h-auto mx-auto mb-1" />
    <h1 class="text-lg font-bold">Fifty Fifty POS</h1>
    <p class="text-xs">Fifty Fifty Phone LLC · At Timar Street, Hili, Al Ain, UAE · TRN: 100254122300003</p>
  </header>

  <!-- Main -->
  <main class="flex-1 container mx-auto p-3 grid grid-cols-1 lg:grid-cols-3 gap-3">

    <!-- POS -->
    <section class="panel bg-white rounded-lg shadow p-3">
      <h2 class="text-lg font-semibold mb-2">POS (Sale)</h2>

      <div class="grid grid-cols-4 gap-2 mb-2">
        <input id="itemName" type="text" placeholder="Name / Scan barcode" class="col-span-2 border p-2 rounded text-sm" />
        <input id="itemQty" type="number" min="1" value="1" placeholder="Qty" class="border p-2 rounded text-sm" />
        <input id="itemPrice" type="number" step="0.01" placeholder="Price (incl. VAT)" class="border p-2 rounded text-sm" />
      </div>

      <div class="flex gap-2 mb-3">
        <button id="addItemBtn" class="flex-1 bg-purple-800 hover:bg-purple-700 text-white py-2 rounded">Add</button>
        <button id="clearBtn" class="bg-red-700 hover:bg-red-600 text-white px-3 rounded">Clear</button>
      </div>

      <div id="itemList" class="border rounded p-2 text-sm h-64 overflow-y-auto">
        <p class="text-center text-gray-500">No items yet</p>
      </div>

      <div class="mt-3 border-t pt-2 text-sm space-y-1">
        <div class="flex justify-between"><span>Subtotal (ex VAT):</span><span id="subtotal">0.00 AED</span></div>
        <div class="flex justify-between"><span>VAT (5%):</span><span id="vat">0.00 AED</span></div>
        <div class="flex justify-between font-bold text-purple-900"><span>Total (incl. VAT):</span><span id="total">0.00 AED</span></div>
      </div>

      <div class="mt-3">
        <label class="block text-sm font-medium mb-1">Payment Method</label>
        <select id="paymentType" class="border p-2 rounded w-full text-sm">
          <option value="Cash">Cash</option>
          <option value="Card">Card</option>
          <option value="Other">Other</option>
        </select>
      </div>

      <div class="mt-3 grid grid-cols-2 gap-2">
        <button id="printBtn" class="bg-green-700 hover:bg-green-600 text-white py-2 rounded">Print Invoice</button>
        <button id="reprintBtn" class="bg-gray-700 hover:bg-gray-600 text-white py-2 rounded">Reprint Last</button>
      </div>
    </section>

    <!-- Inventory -->
    <section class="panel bg-white rounded-lg shadow p-3">
      <h2 class="text-lg font-semibold mb-2">Inventory</h2>

      <div class="grid grid-cols-4 gap-2 mb-2">
        <input id="invName" type="text" placeholder="Item Name" class="col-span-2 border p-2 rounded text-sm" />
        <input id="invBarcode" type="text" placeholder="Barcode" class="border p-2 rounded text-sm" />
        <input id="invQty" type="number" min="0" placeholder="Qty" class="border p-2 rounded text-sm" />
        <input id="invPrice" type="number" step="0.01" placeholder="Price (incl. VAT)" class="border p-2 rounded text-sm" />
      </div>

      <div class="flex gap-2 mb-2">
        <button id="addInvBtn" class="flex-1 bg-purple-700 hover:bg-purple-600 text-white py-2 rounded">Add / Update</button>
        <button id="clearInvBtn" class="bg-red-700 hover:bg-red-600 text-white px-3 rounded">Clear</button>
      </div>

      <div id="invList" class="border rounded p-2 text-sm h-96 overflow-y-auto"></div>
    </section>

    <!-- Right column: History + Reports -->
    <section class="panel bg-white rounded-lg shadow p-3 flex flex-col">
      <div class="mb-3">
        <h2 class="text-lg font-semibold mb-2">Invoice History</h2>
        <div id="historyList" class="border rounded p-2 text-sm h-64 overflow-y-auto"></div>
        <button id="clearHistoryBtn" class="mt-2 w-full bg-red-600 hover:bg-red-500 text-white py-2 rounded">Clear History</button>
      </div>

      <div class="border-t pt-3 mt-auto">
        <h2 class="text-lg font-semibold mb-2">Reports</h2>
        <div class="flex flex-wrap gap-2 mb-2">
          <button id="dailyReport" class="bg-purple-700 hover:bg-purple-600 text-white px-3 py-1 rounded">Daily</button>
          <button id="weeklyReport" class="bg-purple-700 hover:bg-purple-600 text-white px-3 py-1 rounded">Weekly</button>
          <button id="monthlyReport" class="bg-purple-700 hover:bg-purple-600 text-white px-3 py-1 rounded">Monthly</button>
          <button id="exportCSV" class="bg-green-700 hover:bg-green-600 text-white px-3 py-1 rounded">Export CSV</button>
        </div>
        <div id="reportOutput" class="border rounded p-2 text-sm h-56 overflow-y-auto"></div>
      </div>
    </section>
  </main>

  <footer class="no-print text-center text-xs text-gray-600 py-3">
    Thank you for shopping with Fifty Fifty Phone LLC
  </footer>

  <!-- App Logic -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // State
      let items = [];
      let inventory = JSON.parse(localStorage.getItem('inventory') || '[]');
      let invoiceNumber = parseInt(localStorage.getItem('invoiceNumber') || '1', 10);
      let history = JSON.parse(localStorage.getItem('invoiceHistory') || '[]');

      // Elements
      const el = (id) => document.getElementById(id);

      // POS elements
      const itemName = el('itemName'), itemQty = el('itemQty'), itemPrice = el('itemPrice');
      const itemListEl = el('itemList'), subtotalEl = el('subtotal'), vatEl = el('vat'), totalEl = el('total');
      const addItemBtn = el('addItemBtn'), clearBtn = el('clearBtn'), paymentType = el('paymentType');
      const printBtn = el('printBtn'), reprintBtn = el('reprintBtn');

      // Inventory elements
      const invList = el('invList'), invName = el('invName'), invBarcode = el('invBarcode'), invQty = el('invQty'), invPrice = el('invPrice');
      const addInvBtn = el('addInvBtn'), clearInvBtn = el('clearInvBtn');

      // History & Reports
      const historyList = el('historyList'), clearHistoryBtn = el('clearHistoryBtn');
      const dailyReport = el('dailyReport'), weeklyReport = el('weeklyReport'), monthlyReport = el('monthlyReport'), reportOutput = el('reportOutput');
      const exportCSV = el('exportCSV');

      // Utils
      const fmt = (n) => (Number(n || 0)).toFixed(2);
      const saveInv = () => localStorage.setItem('inventory', JSON.stringify(inventory));
      const saveHist = () => localStorage.setItem('invoiceHistory', JSON.stringify(history));
      const saveInvNo = () => localStorage.setItem('invoiceNumber', String(invoiceNumber));

      // VAT-inclusive helpers
      const extractNet = (gross) => gross / 1.05;        // ex VAT
      const extractVat = (gross) => gross - extractNet(gross);

      // Render POS items (VAT-inclusive pricing)
      function renderItems() {
        if (!items.length) {
          itemListEl.innerHTML = '<p class="text-center text-gray-500">No items yet</p>';
          subtotalEl.textContent = '0.00 AED';
          vatEl.textContent = '0.00 AED';
          totalEl.textContent = '0.00 AED';
          return;
        }
        let gross = 0;
        let html = '<table class="table w-full text-xs"><thead><tr class="border-b"><th align="left">Item</th><th>Qty</th><th>Price (incl.)</th><th>Total</th></tr></thead><tbody>';
        items.forEach((it) => {
          const lineGross = it.qty * it.price; gross += lineGross;
          html += `<tr>
            <td>${it.name}</td>
            <td align="center">${it.qty}</td>
            <td align="right">${fmt(it.price)}</td>
            <td align="right">${fmt(lineGross)}</td>
          </tr>`;
        });
        html += '</tbody></table>';
        itemListEl.innerHTML = html;

        const net = extractNet(gross);
        const vat = extractVat(gross);
        subtotalEl.textContent = fmt(net) + ' AED';
        vatEl.textContent = fmt(vat) + ' AED';
        totalEl.textContent = fmt(gross) + ' AED';
      }

      // Render inventory
      function renderInventory() {
        if (!inventory.length) {
          invList.innerHTML = '<p class="text-center text-gray-500">No stock items</p>';
          return;
        }
        let html = '<table class="table w-full text-xs"><thead><tr class="border-b"><th align="left">Name</th><th>Qty</th><th>Price (incl.)</th><th>Barcode</th></tr></thead><tbody>';
        inventory.forEach((it) => {
          html += `<tr>
            <td>${it.name}</td>
            <td>${it.qty}</td>
            <td>${fmt(it.price)}</td>
            <td>${it.barcode || ''}</td>
          </tr>`;
        });
        html += '</tbody></table>';
        invList.innerHTML = html;
      }

      // Render history
      function renderHistory() {
        if (!history.length) {
          historyList.innerHTML = '<p class="text-center text-gray-500">No invoices yet</p>';
          return;
        }
        let html = '<table class="table w-full text-xs"><thead><tr class="border-b"><th>#</th><th>Date</th><th>Total</th><th>Pay</th><th>Status</th><th></th><th></th></tr></thead><tbody>';
        history.forEach((inv, i) => {
          const status = inv.refunded ? '<span class="text-red-600 font-semibold">Refunded</span>' : '<span class="text-green-700">Completed</span>';
          const refundBtn = inv.refunded ? '' : `<button data-i="${i}" class="refund text-rose-600 underline">Refund</button>`;
          const reprintBtn = `<button data-i="${i}" class="reprint text-blue-600 underline">Reprint</button>`;
          html += `<tr>
            <td>${inv.no}</td>
            <td>${inv.date}</td>
            <td>${fmt(inv.total)}</td>
            <td>${inv.pay}</td>
            <td>${status}</td>
            <td>${reprintBtn}</td>
            <td>${refundBtn}</td>
          </tr>`;
        });
        html += '</tbody></table>';
        historyList.innerHTML = html;

        // Reprint handlers
        historyList.querySelectorAll('.reprint').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const i = Number(e.target.getAttribute('data-i'));
            const inv = history[i];
            const w = window.open('', '', 'width=400,height=600');
            w.document.write(inv.html);
            w.print();
            w.close();
          });
        });

        // Refund handlers
        historyList.querySelectorAll('.refund').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const i = Number(e.target.getAttribute('data-i'));
            const inv = history[i];
            if (!inv || inv.refunded) return;
            if (!confirm(`Refund invoice #${inv.no}?`)) return;

            // Restore stock
            (inv.items || []).forEach(sold => {
              const stock = inventory.find(x => x.name === sold.name || (x.barcode && x.barcode === sold.barcode));
              if (stock) {
                stock.qty = (Number(stock.qty) || 0) + Number(sold.qty || 0);
              } else {
                // If it didn't exist (edge case), recreate it
                inventory.push({ name: sold.name, barcode: sold.barcode || '', qty: Number(sold.qty || 0), price: Number(sold.price || 0) });
              }
            });
            saveInv();
            renderInventory();

            // Mark refunded
            inv.refunded = true;
            saveHist();
            renderHistory();
          });
        });
      }

      // POS: add item
      addItemBtn.addEventListener('click', () => {
        const name = itemName.value.trim();
        const qty = parseFloat(itemQty.value);
        const price = parseFloat(itemPrice.value);
        if (!name || qty <= 0 || price <= 0) return alert('Enter valid item details');

        // Try to match inventory by name/barcode; reduce qty
        const invItem = inventory.find(i => i.name === name || (i.barcode && i.barcode === name));
        if (invItem) {
          if (invItem.qty < qty) return alert('Not enough stock');
          invItem.qty -= qty; saveInv(); renderInventory();
        }
        // Store VAT-inclusive price
        items.push({ name, qty, price });
        itemName.value = ''; itemQty.value = 1; itemPrice.value = '';
        renderItems();
      });

      // Barcode via Enter on name field (match barcode)
      itemName.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          const code = itemName.value.trim();
          const found = inventory.find(i => i.barcode === code);
          if (found) {
            if (found.qty < 1) return alert('Out of stock');
            found.qty -= 1; saveInv(); renderInventory();
            items.push({ name: found.name, qty: 1, price: Number(found.price) });
            itemName.value = ''; renderItems(); e.preventDefault();
          }
        }
      });

      // POS: clear
      clearBtn.addEventListener('click', () => {
        if (confirm('Clear all items?')) { items = []; renderItems(); }
      });

      // POS: print (store items for refund)
      printBtn.addEventListener('click', () => {
        if (!items.length) return alert('No items to print');
        const date = new Date().toLocaleString();

        const gross = items.reduce((s, i) => s + i.qty * i.price, 0);
        const net = extractNet(gross);
        const vat = extractVat(gross);
        const pay = paymentType.value;

        const html = `
          <div style="width:72mm;font-family:monospace">
            <div style="text-align:center">
              <img src="logo.png" style="width:60px;height:auto"><br>
              <strong>Fifty Fifty Phone LLC</strong><br>
              At Timar Street, Hili, Al Ain, UAE<br>
              TRN: 100254122300003<br>
              -----------------------------<br>
              Invoice #: ${invoiceNumber}<br>
              Date: ${date}<br>
              -----------------------------<br>
            </div>
            <table style="width:100%;font-size:12px">
              ${items.map(i => `<tr><td>${i.name}</td><td align="right">${i.qty}×${fmt(i.price)}</td></tr>`).join('')}
            </table>
            -----------------------------<br>
            Subtotal (ex VAT): ${fmt(net)} AED<br>
            VAT (5%): ${fmt(vat)} AED<br>
            Total (incl. VAT): ${fmt(gross)} AED<br>
            Payment: ${pay}<br>
            -----------------------------<br>
            Thank you for shopping with Fifty Fifty Phone LLC
          </div>`;

        const w = window.open('', '', 'width=400,height=600');
        w.document.write(html);
        w.print();
        w.close();

        // Store full invoice with items (for refunds)
        history.push({
          no: invoiceNumber,
          date,
          total: gross,
          pay,
          html,
          refunded: false,
          // Save items so we can restore stock later
          items: items.map(i => ({ name: i.name, qty: i.qty, price: i.price }))
        });
        saveHist();
        invoiceNumber += 1; saveInvNo();

        items = [];
        renderItems();
        renderHistory();
      });

      // POS: reprint last
      reprintBtn.addEventListener('click', () => {
        if (!history.length) return alert('No last invoice');
        const inv = history[history.length - 1];
        const w = window.open('', '', 'width=400,height=600');
        w.document.write(inv.html);
        w.print(); w.close();
      });

      // Inventory: add/update (price stored VAT-inclusive)
      addInvBtn.addEventListener('click', () => {
        const name = invName.value.trim();
        const barcode = (invBarcode.value || '').trim();
        const qty = parseFloat(invQty.value);
        const price = parseFloat(invPrice.value);
        if (!name || qty < 0 || price <= 0) return alert('Enter valid inventory details');

        const existing = inventory.find(i => i.name === name || (barcode && i.barcode === barcode));
        if (existing) {
          existing.qty = (existing.qty || 0) + qty;
          existing.price = price;
          if (barcode) existing.barcode = barcode;
        } else {
          inventory.push({ name, barcode, qty, price });
        }
        invName.value = invBarcode.value = invQty.value = invPrice.value = '';
        saveInv(); renderInventory();
      });

      // Inventory: clear
      clearInvBtn.addEventListener('click', () => {
        if (confirm('Clear all inventory?')) {
          inventory = []; saveInv(); renderInventory();
        }
      });

      // History: clear
      clearHistoryBtn.addEventListener('click', () => {
        if (confirm('Delete all history?')) {
          history = []; saveHist(); renderHistory();
        }
      });

      // Reports (exclude refunded)
      function summarize(period) {
        const now = new Date();
        let start;
        if (period === 'daily') start = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        else if (period === 'weekly') start = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 7);
        else start = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());

        const filtered = history.filter(inv => !inv.refunded && new Date(inv.date) >= start);
        if (!filtered.length) { reportOutput.innerHTML = '<p class="text-center text-gray-500">No invoices in this period.</p>'; return; }

        const totalSales = filtered.reduce((s, i) => s + Number(i.total || 0), 0);
        const vatSum = totalSales - (totalSales / 1.05); // extracted VAT from gross totals
        const payBreakdown = filtered.reduce((acc, i) => {
          acc[i.pay] = (acc[i.pay] || 0) + Number(i.total || 0);
          return acc;
        }, {});

        let html = `<div class="space-y-1">
          <p><strong>${period.toUpperCase()} REPORT</strong></p>
          <p>Total Invoices: ${filtered.length}</p>
          <p>Total Sales (incl. VAT): ${fmt(totalSales)} AED</p>
          <p>VAT (5% extracted): ${fmt(vatSum)} AED</p>
          <hr>
          <p><strong>By Payment Type:</strong></p>
          <ul class="list-disc ml-5">` +
          Object.keys(payBreakdown).map(p => `<li>${p}: ${fmt(payBreakdown[p])} AED</li>`).join('') +
          `</ul>
          <hr>
          <div class="overflow-x-auto">
            <table class="table w-full text-xs">
              <thead><tr><th>No</th><th>Date</th><th>Total (incl.)</th><th>Payment</th></tr></thead>
              <tbody>` +
              filtered.map(i => `<tr><td>${i.no}</td><td>${i.date}</td><td>${fmt(i.total)}</td><td>${i.pay}</td></tr>`).join('') +
              `</tbody>
            </table>
          </div>
        </div>`;
        reportOutput.innerHTML = html;
      }

      dailyReport.addEventListener('click', () => summarize('daily'));
      weeklyReport.addEventListener('click', () => summarize('weekly'));
      monthlyReport.addEventListener('click', () => summarize('monthly'));

      // CSV Export (marks refunded invoices)
      exportCSV.addEventListener('click', () => {
        if (!history.length) return alert('No invoices to export');
        const rows = [['Invoice No','Date','Total (incl. VAT)','Payment','Status']];
        history.forEach(i => {
          rows.push([i.no, i.date, fmt(i.total), i.pay, i.refunded ? 'Refunded' : 'Completed']);
        });
        const csv = rows.map(r => r.join(',')).join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'FiftyFiftyPOS_Reports.csv'; a.click();
      });

      // Initial renders
      renderInventory();
      renderItems();
      renderHistory();
    });
  </script>
</body>
</html>
