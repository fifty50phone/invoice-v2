<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fifty Fifty POS v2</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome for Icons (Optional but nice) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    /* 72mm thermal printing */
    @media print {
      body { width: 72mm; margin: 0; font-size: 12px; font-family: monospace; }
      .no-print { display: none !important; }
      .print-only { display: block !important; }
    }
    
    /* Screen styling */
    .print-only { display: none; }
    .panel { min-height: 520px; }
    .table th, .table td { padding: 4px 6px; }
    
    /* Scrollbar styling for lists */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #888; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #555; }
  </style>
</head>
<body class="bg-gray-100 text-gray-900 min-h-screen flex flex-col font-sans">

  <!-- Header -->
  <header class="no-print bg-purple-900 text-white text-center py-3 shadow-md">
    <div class="flex items-center justify-center gap-2">
        <i class="fa-solid fa-mobile-screen-button text-2xl"></i>
        <h1 class="text-xl font-bold tracking-wide">Fifty Fifty POS</h1>
    </div>
    <p class="text-xs text-purple-200 mt-1">Fifty Fifty Phone LLC · At Timar Street, Hili, Al Ain, UAE · TRN: 100254122300003</p>
  </header>

  <!-- Main -->
  <main class="flex-1 container mx-auto p-3 grid grid-cols-1 lg:grid-cols-3 gap-3">

    <!-- POS Section -->
    <section class="panel bg-white rounded-lg shadow-md p-4 border border-gray-200 flex flex-col">
      <h2 class="text-lg font-bold text-gray-800 mb-3 border-b pb-2 flex justify-between items-center">
        <span><i class="fa-solid fa-cart-shopping mr-2 text-purple-700"></i>New Sale</span>
        <span class="text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded">POS</span>
      </h2>

      <div class="grid grid-cols-4 gap-2 mb-2">
        <input id="itemName" type="text" placeholder="Name / Scan barcode" class="col-span-2 border p-2 rounded text-sm focus:outline-none focus:ring-2 focus:ring-purple-500" autofocus />
        <input id="itemQty" type="number" min="1" value="1" placeholder="Qty" class="border p-2 rounded text-sm focus:outline-none focus:ring-2 focus:ring-purple-500" />
        <input id="itemPrice" type="number" step="0.01" placeholder="Price (incl. VAT)" class="border p-2 rounded text-sm focus:outline-none focus:ring-2 focus:ring-purple-500" />
      </div>

      <div class="flex gap-2 mb-3">
        <button id="addItemBtn" class="flex-1 bg-purple-800 hover:bg-purple-900 text-white py-2 rounded text-sm font-semibold transition"><i class="fa-solid fa-plus mr-1"></i> Add Item</button>
        <button id="clearBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 rounded text-sm font-semibold transition">Clear</button>
      </div>

      <!-- Current Order List -->
      <div id="itemList" class="border rounded p-2 text-sm flex-1 overflow-y-auto bg-gray-50 mb-3">
        <div class="h-full flex flex-col justify-center items-center text-gray-400">
            <i class="fa-solid fa-basket-shopping text-3xl mb-2"></i>
            <p>Cart is empty</p>
        </div>
      </div>

      <!-- Totals -->
      <div class="bg-gray-50 p-3 rounded border border-gray-200 text-sm space-y-1">
        <div class="flex justify-between text-gray-600"><span>Subtotal (ex VAT):</span><span id="subtotal">0.00 AED</span></div>
        <div class="flex justify-between text-gray-600"><span>VAT (5%):</span><span id="vat">0.00 AED</span></div>
        <div class="flex justify-between font-bold text-lg text-purple-900 border-t pt-1 mt-1"><span>Total:</span><span id="total">0.00 AED</span></div>
      </div>

      <div class="mt-3">
        <label class="block text-xs font-semibold text-gray-600 mb-1">PAYMENT METHOD</label>
        <select id="paymentType" class="border p-2 rounded w-full text-sm bg-white">
          <option value="Cash">Cash</option>
          <option value="Card">Card</option>
          <option value="Transfer">Bank Transfer</option>
        </select>
      </div>

      <div class="mt-3 grid grid-cols-2 gap-2">
        <button id="printBtn" class="bg-green-600 hover:bg-green-700 text-white py-3 rounded font-bold shadow transition"><i class="fa-solid fa-print mr-2"></i>PRINT</button>
        <button id="reprintBtn" class="bg-gray-600 hover:bg-gray-700 text-white py-3 rounded font-bold shadow transition"><i class="fa-solid fa-clock-rotate-left mr-2"></i>LAST</button>
      </div>
    </section>

    <!-- Inventory Section -->
    <section class="panel bg-white rounded-lg shadow-md p-4 border border-gray-200 flex flex-col">
      <h2 class="text-lg font-bold text-gray-800 mb-3 border-b pb-2 flex justify-between items-center">
        <span><i class="fa-solid fa-boxes-stacked mr-2 text-blue-600"></i>Inventory</span>
        <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">Stock</span>
      </h2>

      <div class="grid grid-cols-4 gap-2 mb-2">
        <input id="invName" type="text" placeholder="Item Name" class="col-span-2 border p-2 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
        <input id="invBarcode" type="text" placeholder="Barcode" class="border p-2 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
        <input id="invQty" type="number" min="0" placeholder="Qty" class="border p-2 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
        <input id="invPrice" type="number" step="0.01" placeholder="Price" class="col-span-4 border p-2 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
      </div>

      <div class="flex gap-2 mb-2">
        <button id="addInvBtn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 rounded text-sm font-semibold transition">Update Stock</button>
        <button id="clearInvBtn" class="bg-red-50 text-red-600 hover:bg-red-100 px-3 rounded text-sm font-semibold border border-red-200 transition">Reset</button>
      </div>

      <div id="invList" class="border rounded p-0 text-sm flex-1 overflow-y-auto bg-white">
          <!-- Inventory Table Injected Here -->
      </div>
    </section>

    <!-- History & Reports Section -->
    <section class="panel bg-white rounded-lg shadow-md p-4 border border-gray-200 flex flex-col">
      
      <!-- History -->
      <div class="flex-1 flex flex-col min-h-0 mb-4">
        <h2 class="text-lg font-bold text-gray-800 mb-2 flex justify-between items-center">
            <span><i class="fa-solid fa-list mr-2 text-gray-600"></i>Sales History</span>
            <button id="clearHistoryBtn" class="text-xs text-red-500 hover:text-red-700 underline">Clear</button>
        </h2>
        <div id="historyList" class="border rounded p-0 text-sm flex-1 overflow-y-auto bg-white">
            <!-- History Table Injected Here -->
        </div>
      </div>

      <!-- Reports -->
      <div class="border-t pt-3 mt-auto h-1/3 flex flex-col">
        <h2 class="text-sm font-bold text-gray-800 mb-2 uppercase tracking-wide">Generarte Reports</h2>
        <div class="flex flex-wrap gap-2 mb-2">
          <button id="dailyReport" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-800 px-2 py-1 rounded text-xs border">Daily</button>
          <button id="weeklyReport" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-800 px-2 py-1 rounded text-xs border">Weekly</button>
          <button id="monthlyReport" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-800 px-2 py-1 rounded text-xs border">Monthly</button>
          <button id="exportCSV" class="bg-green-50 text-green-700 hover:bg-green-100 px-3 py-1 rounded text-xs border border-green-200"><i class="fa-solid fa-file-csv"></i> Export</button>
        </div>
        <div id="reportOutput" class="bg-yellow-50 border border-yellow-100 rounded p-2 text-xs flex-1 overflow-y-auto">
            <p class="text-gray-400 text-center mt-2">Select a report period...</p>
        </div>
      </div>
    </section>

  </main>

  <footer class="no-print text-center text-xs text-gray-500 py-3">
    System Ready • Local Storage Enabled
  </footer>

  <!-- App Logic -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // --- STATE MANAGEMENT ---
      let items = [];
      let inventory = JSON.parse(localStorage.getItem('inventory') || '[]');
      let invoiceNumber = parseInt(localStorage.getItem('invoiceNumber') || '1001', 10); // Start at 1001 looks better
      let history = JSON.parse(localStorage.getItem('invoiceHistory') || '[]');

      // --- ELEMENTS ---
      const el = (id) => document.getElementById(id);

      // POS Inputs
      const itemName = el('itemName'), itemQty = el('itemQty'), itemPrice = el('itemPrice');
      const itemListEl = el('itemList'), subtotalEl = el('subtotal'), vatEl = el('vat'), totalEl = el('total');
      const addItemBtn = el('addItemBtn'), clearBtn = el('clearBtn'), paymentType = el('paymentType');
      const printBtn = el('printBtn'), reprintBtn = el('reprintBtn');

      // Inventory Inputs
      const invList = el('invList'), invName = el('invName'), invBarcode = el('invBarcode'), invQty = el('invQty'), invPrice = el('invPrice');
      const addInvBtn = el('addInvBtn'), clearInvBtn = el('clearInvBtn');

      // Reports/History Inputs
      const historyList = el('historyList'), clearHistoryBtn = el('clearHistoryBtn');
      const dailyReport = el('dailyReport'), weeklyReport = el('weeklyReport'), monthlyReport = el('monthlyReport'), reportOutput = el('reportOutput');
      const exportCSV = el('exportCSV');

      // --- UTILITIES ---
      const fmt = (n) => (Number(n || 0)).toFixed(2);
      const saveInv = () => localStorage.setItem('inventory', JSON.stringify(inventory));
      const saveHist = () => localStorage.setItem('invoiceHistory', JSON.stringify(history));
      const saveInvNo = () => localStorage.setItem('invoiceNumber', String(invoiceNumber));

      // VAT Math (Inclusive)
      const extractNet = (gross) => gross / 1.05;        // ex VAT
      const extractVat = (gross) => gross - extractNet(gross);

      // --- RENDERING ---
      
      // Render POS Cart
      function renderItems() {
        if (!items.length) {
          itemListEl.innerHTML = `
            <div class="h-full flex flex-col justify-center items-center text-gray-400">
                <i class="fa-solid fa-basket-shopping text-3xl mb-2"></i>
                <p>Cart is empty</p>
            </div>`;
          subtotalEl.textContent = '0.00 AED';
          vatEl.textContent = '0.00 AED';
          totalEl.textContent = '0.00 AED';
          return;
        }
        
        let gross = 0;
        let html = '<table class="table w-full text-xs"><thead><tr class="bg-gray-100 text-gray-600 border-b"><th class="text-left p-2">Item</th><th class="p-2">Qty</th><th class="text-right p-2">Price</th><th class="text-right p-2">Total</th><th class="w-8"></th></tr></thead><tbody>';
        
        items.forEach((it, idx) => {
          const lineGross = it.qty * it.price; 
          gross += lineGross;
          html += `<tr class="border-b hover:bg-gray-50">
            <td class="p-2">${it.name}</td>
            <td class="p-2 text-center">${it.qty}</td>
            <td class="p-2 text-right">${fmt(it.price)}</td>
            <td class="p-2 text-right font-semibold">${fmt(lineGross)}</td>
            <td class="p-2 text-center"><button onclick="removeItem(${idx})" class="text-red-500 hover:text-red-700"><i class="fa-solid fa-trash"></i></button></td>
          </tr>`;
        });
        html += '</tbody></table>';
        itemListEl.innerHTML = html;

        const net = extractNet(gross);
        const vat = extractVat(gross);
        subtotalEl.textContent = fmt(net) + ' AED';
        vatEl.textContent = fmt(vat) + ' AED';
        totalEl.textContent = fmt(gross) + ' AED';
      }

      // Make removeItem global so the inline onclick works
      window.removeItem = (idx) => {
        // Return qty to inventory if we wanted to lock stock on add, but here we only dedcut on print.
        // For now just remove from cart.
        items.splice(idx, 1);
        renderItems();
      };

      // Render Inventory Table
      function renderInventory() {
        if (!inventory.length) {
          invList.innerHTML = '<p class="text-center text-gray-400 p-4">No stock items added.</p>';
          return;
        }
        let html = '<table class="table w-full text-xs"><thead><tr class="bg-gray-100 text-gray-600 border-b"><th class="text-left p-2">Name</th><th class="p-2">Qty</th><th class="text-right p-2">Price</th><th class="text-right p-2">Code</th></tr></thead><tbody>';
        inventory.forEach((it) => {
          // Highlight low stock
          const lowStockClass = it.qty < 3 ? 'text-red-600 font-bold' : '';
          html += `<tr class="border-b hover:bg-gray-50">
            <td class="p-2">${it.name}</td>
            <td class="p-2 text-center ${lowStockClass}">${it.qty}</td>
            <td class="p-2 text-right">${fmt(it.price)}</td>
            <td class="p-2 text-right text-gray-400 font-mono">${it.barcode || '-'}</td>
          </tr>`;
        });
        html += '</tbody></table>';
        invList.innerHTML = html;
      }

      // Render Sales History
      function renderHistory() {
        if (!history.length) {
          historyList.innerHTML = '<p class="text-center text-gray-400 p-4">No sales yet.</p>';
          return;
        }
        // Show newest first
        const reversedHistory = [...history].reverse();
        
        let html = '<table class="table w-full text-xs"><thead><tr class="bg-gray-100 text-gray-600 border-b"><th class="text-left p-2">#</th><th class="p-2">Date</th><th class="text-right p-2">Total</th><th class="text-center p-2">Status</th><th class="p-2"></th></tr></thead><tbody>';
        
        reversedHistory.forEach((inv) => {
          // Find original index for actions
          const originalIndex = history.indexOf(inv);
          
          const statusBadge = inv.refunded 
            ? '<span class="bg-red-100 text-red-800 px-1 rounded">Ref</span>' 
            : '<span class="bg-green-100 text-green-800 px-1 rounded">Ok</span>';
          
          const refundBtn = inv.refunded 
            ? '' 
            : `<button class="refund-btn text-red-500 hover:text-red-700 ml-2" data-idx="${originalIndex}" title="Refund"><i class="fa-solid fa-rotate-left"></i></button>`;
            
          const reprintBtn = `<button class="reprint-btn text-blue-500 hover:text-blue-700" data-idx="${originalIndex}" title="Reprint"><i class="fa-solid fa-print"></i></button>`;

          html += `<tr class="border-b hover:bg-gray-50">
            <td class="p-2 font-mono text-gray-600">#${inv.no}</td>
            <td class="p-2 text-gray-500" style="font-size:10px">${inv.date.split(',')[0]}</td>
            <td class="p-2 text-right font-semibold">${fmt(inv.total)}</td>
            <td class="p-2 text-center">${statusBadge}</td>
            <td class="p-2 text-right">${reprintBtn}${refundBtn}</td>
          </tr>`;
        });
        html += '</tbody></table>';
        historyList.innerHTML = html;
        
        // Re-attach listeners since innerHTML wipes them
        document.querySelectorAll('.reprint-btn').forEach(b => {
            b.addEventListener('click', (e) => {
                const idx = e.currentTarget.getAttribute('data-idx');
                doReprint(idx);
            })
        });
        document.querySelectorAll('.refund-btn').forEach(b => {
            b.addEventListener('click', (e) => {
                const idx = e.currentTarget.getAttribute('data-idx');
                doRefund(idx);
            })
        });
      }

      // --- LOGIC ---

      // Add Item to Cart
      addItemBtn.addEventListener('click', () => {
        const name = itemName.value.trim();
        const qty = parseFloat(itemQty.value);
        const price = parseFloat(itemPrice.value);
        if (!name || qty <= 0 || price <= 0) return alert('Enter valid item details');

        // Check stock
        const invItem = inventory.find(i => i.name === name || (i.barcode && i.barcode === name));
        
        // Note: We don't deduct stock HERE, we deduct on PRINT. 
        // But we can warn user.
        if (invItem && invItem.qty < qty) {
            if(!confirm(`Warning: Low Stock! Available: ${invItem.qty}. Continue?`)) return;
        }

        items.push({ name, qty, price });
        
        // Reset inputs
        itemName.value = ''; 
        itemQty.value = 1; 
        itemPrice.value = '';
        itemName.focus();
        
        renderItems();
      });

      // Handle Barcode Scanner (Enter key)
      itemName.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          const code = itemName.value.trim();
          if(!code) return;
          
          const found = inventory.find(i => i.barcode === code);
          if (found) {
            // Check stock
            if (found.qty < 1) {
                alert('Item out of stock!');
                return;
            }
            // Add directly
            items.push({ name: found.name, qty: 1, price: Number(found.price) });
            itemName.value = ''; 
            renderItems(); 
          } else {
             // If not found, just move focus to price so they can enter manual item
             itemPrice.focus();
          }
          e.preventDefault();
        }
      });

      // Clear Cart
      clearBtn.addEventListener('click', () => {
        if (items.length && confirm('Clear current cart?')) { items = []; renderItems(); }
      });

      // --- INVENTORY LOGIC ---
      addInvBtn.addEventListener('click', () => {
        const name = invName.value.trim();
        const barcode = (invBarcode.value || '').trim();
        const qty = parseFloat(invQty.value);
        const price = parseFloat(invPrice.value);
        
        if (!name || isNaN(qty) || isNaN(price)) return alert('Please enter valid details');

        const existing = inventory.find(i => i.name === name || (barcode && i.barcode === barcode));
        
        if (existing) {
          existing.qty = (Number(existing.qty) || 0) + qty;
          existing.price = price;
          if (barcode) existing.barcode = barcode;
        } else {
          inventory.push({ name, barcode, qty, price });
        }
        
        // Clear inputs
        invName.value = ''; invBarcode.value = ''; invQty.value = ''; invPrice.value = '';
        saveInv(); 
        renderInventory();
      });

      clearInvBtn.addEventListener('click', () => {
        if (confirm('DANGER: Delete ALL inventory records?')) {
          inventory = []; saveInv(); renderInventory();
        }
      });

      // --- PRINT HELPER (Iframe method to avoid popup issues) ---
      function printReceipt(htmlContent) {
        // Create a hidden iframe
        const iframe = document.createElement('iframe');
        // Hide it visually but keep it in layout for rendering
        iframe.style.position = 'absolute';
        iframe.style.width = '0px';
        iframe.style.height = '0px';
        iframe.style.border = 'none';
        document.body.appendChild(iframe);
        
        // Write content to iframe
        const doc = iframe.contentWindow.document;
        doc.open();
        doc.write(`
            <html>
                <head>
                    <title>Print Receipt</title>
                    <style>
                        body { margin: 0; padding: 0; font-family: 'Courier New', monospace; }
                        @media print {
                            @page { margin: 0; size: 72mm auto; }
                        }
                    </style>
                </head>
                <body>
                    ${htmlContent}
                </body>
            </html>
        `);
        doc.close();

        // Wait for content to load then print
        iframe.contentWindow.focus();
        setTimeout(() => {
            iframe.contentWindow.print();
            // Remove iframe after a delay to ensure print dialog opened
            setTimeout(() => {
                document.body.removeChild(iframe);
            }, 2000); // 2 second delay before removing iframe
        }, 500);
      }

      // --- PRINT & TRANSACTION LOGIC ---
      printBtn.addEventListener('click', () => {
        if (!items.length) return alert('Cart is empty!');
        
        const date = new Date().toLocaleString();
        const gross = items.reduce((s, i) => s + i.qty * i.price, 0);
        const net = extractNet(gross);
        const vat = extractVat(gross);
        const pay = paymentType.value;

        // 1. Deduct Stock
        items.forEach(cartItem => {
            const stockItem = inventory.find(i => i.name === cartItem.name || (i.barcode && i.barcode === cartItem.name));
            if(stockItem) {
                stockItem.qty = Math.max(0, stockItem.qty - cartItem.qty);
            }
        });
        saveInv();
        renderInventory();

        // 2. Generate HTML for Receipt
        const receiptHTML = `
          <div style="font-family:'Courier New', monospace; font-size:12px; width:72mm; margin:0 auto;">
            <div style="text-align:center; margin-bottom:10px;">
              <img src="logo.png" onerror="this.style.display='none'" style="width:60px; height:auto; margin-bottom:5px;"><br>
              <strong style="font-size:14px">Fifty Fifty Phone LLC</strong><br>
              At Timar Street, Hili, Al Ain, UAE<br>
              TRN: 100254122300003<br>
              --------------------------------<br>
              <strong>INVOICE #${invoiceNumber}</strong><br>
              ${date}<br>
              --------------------------------<br>
            </div>
            <table style="width:100%; font-size:12px; border-collapse: collapse;">
              ${items.map(i => `
                  <tr>
                    <td style="padding:2px 0;">${i.name}</td>
                    <td style="text-align:right; white-space:nowrap;">${i.qty} x ${fmt(i.price)}</td>
                  </tr>
                  <tr><td colspan="2" style="text-align:right; padding-bottom:4px; border-bottom:1px dashed #ccc;">${fmt(i.qty*i.price)}</td></tr>
              `).join('')}
            </table>
            <div style="text-align:right; margin-top:10px;">
              Subtotal: ${fmt(net)} AED<br>
              VAT (5%): ${fmt(vat)} AED<br>
              <strong style="font-size:14px">TOTAL: ${fmt(gross)} AED</strong><br>
              Paid via: ${pay}
            </div>
            <div style="text-align:center; margin-top:15px; border-top:1px dashed #000; padding-top:10px;">
              Thank you for shopping!<br>
              No Warranty on Software
            </div>
          </div>`;

        // 3. Print via Iframe
        printReceipt(receiptHTML);

        // 4. Save to History
        history.push({
          no: invoiceNumber,
          date,
          total: gross,
          pay,
          html: receiptHTML,
          refunded: false,
          items: JSON.parse(JSON.stringify(items)) // copy items
        });
        saveHist();
        
        // 5. Increment Invoice No
        invoiceNumber++;
        saveInvNo();

        // 6. Reset POS
        items = [];
        renderItems();
        renderHistory();
      });

      // --- HISTORY FUNCTIONS ---
      function doReprint(idx) {
        const inv = history[idx];
        if(!inv) return;
        printReceipt(inv.html);
      }

      function doRefund(idx) {
        const inv = history[idx];
        if(!inv || inv.refunded) return;
        if(!confirm(`Refund Invoice #${inv.no} for ${fmt(inv.total)} AED? This will restore stock.`)) return;

        // Restore Stock
        inv.items.forEach(sold => {
            const stock = inventory.find(x => x.name === sold.name || (x.barcode && x.barcode === sold.barcode));
            if(stock) {
                stock.qty = (Number(stock.qty) || 0) + Number(sold.qty);
            } else {
                // recreate if deleted
                inventory.push({ name: sold.name, qty: sold.qty, price: sold.price, barcode: '' });
            }
        });
        saveInv();
        renderInventory();

        // Mark Refunded
        inv.refunded = true;
        saveHist();
        renderHistory();
      }

      clearHistoryBtn.addEventListener('click', () => {
          if(confirm('Delete entire sales history? This cannot be undone.')) {
              history = []; saveHist(); renderHistory();
          }
      });

      // --- REPORTS ---
      function generateReport(period) {
        const now = new Date();
        let start;
        now.setHours(0,0,0,0); // start of today

        if (period === 'daily') start = now;
        else if (period === 'weekly') { start = new Date(now); start.setDate(now.getDate() - 7); }
        else { start = new Date(now); start.setMonth(now.getMonth() - 1); }

        const filtered = history.filter(inv => !inv.refunded && new Date(inv.date.split(',')[0]) >= start);
        
        if (!filtered.length) { 
            reportOutput.innerHTML = `<p class="text-center text-gray-500 mt-2">No active sales for ${period} period.</p>`; 
            return; 
        }

        const totalSales = filtered.reduce((s, i) => s + Number(i.total), 0);
        const vatSum = totalSales - (totalSales / 1.05);

        reportOutput.innerHTML = `
            <div class="space-y-1">
                <p class="font-bold border-b pb-1 text-purple-900">${period.toUpperCase()} REPORT</p>
                <div class="grid grid-cols-2 gap-2 mt-2">
                    <div class="bg-white p-2 rounded border">
                        <span class="text-gray-500 block">Sales</span>
                        <span class="font-bold text-lg">${fmt(totalSales)}</span>
                    </div>
                    <div class="bg-white p-2 rounded border">
                        <span class="text-gray-500 block">Invoices</span>
                        <span class="font-bold text-lg">${filtered.length}</span>
                    </div>
                </div>
                <p class="text-xs text-gray-500 mt-2">VAT Collected (Approx): ${fmt(vatSum)} AED</p>
            </div>
        `;
      }

      dailyReport.addEventListener('click', () => generateReport('daily'));
      weeklyReport.addEventListener('click', () => generateReport('weekly'));
      monthlyReport.addEventListener('click', () => generateReport('monthly'));

      // CSV Export
      exportCSV.addEventListener('click', () => {
        if (!history.length) return alert('No data to export');
        
        let csvContent = "data:text/csv;charset=utf-8,Invoice No,Date,Total,Payment,Status\n";
        history.forEach(row => {
            const status = row.refunded ? "REFUNDED" : "COMPLETED";
            csvContent += `${row.no},"${row.date}",${row.total},${row.pay},${status}\n`;
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "sales_report.csv");
        document.body.appendChild(link);
        link.click();
      });

      // --- INITIAL LOAD ---
      renderInventory();
      renderItems();
      renderHistory();
    });
  </script>
</body>
</html>
